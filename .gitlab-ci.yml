image: alpine:latest

include:
  - template: Security/Secret-Detection.gitlab-ci.yml

build_job:
  stage: build

  before_script:
    - apk update && apk add brotli curl grep

  script:
    - sh src/script.sh
    - find public -type f -regex '.*\.\(txt\|conf\|tpl\|rules\)$' -exec gzip -f -k -9 {} \;
    - find public -type f -regex '.*\.\(txt\|conf\|tpl\|rules\)$' -exec brotli -f -k -9 {} \;

  artifacts:
    paths:
      - tmp
      - public

pages:
  stage: deploy

  script:
    - echo

  artifacts:
    paths:
      - public

  rules:
    # Only trigger when commit to main branch
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

netlify:
  stage: deploy

  before_script:
      - apk update && apk add curl

  script:
    - curl -X POST -d '{}' https://api.netlify.com/build_hooks/$NETLIFY_BUILD_HOOK

  rules:
    # Only trigger through schedule job and "Run pipeline" in the main branch
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && ($CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web")'
